rem -------------------------
rem -- Flying saucers
rem --
rem -- Written by
rem -- Csaba Fekete
rem --
rem -- Graphics
rem -- Daniel Fekete
rem -------------------------

debug! = 0

proc music_player
  sys $5440
endproc

include "ext/xcb-ext-sprite.bas"
include "ext/xcb-ext-joystick.bas"
include "ext/xcb-ext-rasterinterrupt.bas"
include "inc/globals.bas"
include "inc/proc_configure_sprites.bas"
include "inc/proc_logo.bas"

gosub instructions
goto main

include "inc/proc_update_sprites.bas"
include "inc/proc_shift.bas"
include "inc/proc_query_joystick.bas"
include "inc/proc_poll_collisions.bas"
include "inc/proc_setup_screen.bas"
include "inc/proc_update_radar.bas"
include "inc/proc_intro.bas"
include "inc/proc_actions.bas"
include "inc/proc_move_ufos.bas"

main:

poke VIC_CONTROL2, VIC_CTR_DEFAULT!
poke VIC_MEMSETUP, %00011000
poke VIC_BORDER, 0 : poke VIC_BACKGR, 0

call intro
call configure_sprites
spr_enable 7
let city_map_ptr_right = CITY_MAP_DEFAULT_PTR_RIGHT
let city_map_ptr_left  = CITY_MAP_DEFAULT_PTR_LEFT

rem -- play starts here

call setup_screen(1)
;call configure_sprites

for addr = $d400 to $d418
  poke addr, 0
next addr

poke $d418, 31
poke $d404, 129
''poke $d40b, %00010101

poke $d405, 32
poke $d406, 128
poke $d416, 0
poke $d417, 1
''poke $d40c, 32
''poke $d40d, $88

rem --------------------------------------------
rem -- Set graphics properties on top of screen 
rem --------------------------------------------

proc interrupt1
  poke \VIC_CONTROL2, \VIC_CTR_DEFAULT!
endproc

rem ----------------------------------------------
rem -- Set graphics properties after the dashboard 
rem -- is drawn 
rem ----------------------------------------------

proc interrupt2
  poke $d022, 15 : poke $d023, 12
endproc

rem -----------------------------------------------
rem -- Set graphics properties before the scrolling
rem -- area is drawn 
rem -----------------------------------------------

proc interrupt3
  poke \VIC_CONTROL2, \VIC_CTR_DEFAULT! | \scroll!
  poke $d022, 7 : poke $d023, 2
endproc

rem -----------------------------------------------
rem -- Set up raster interrupts 
rem -----------------------------------------------

ri_isr_count! = 3
ri_set_isr 0, @interrupt1, 50
ri_set_isr 1, @interrupt2, 90
ri_set_isr 2, @interrupt3, 176
ri_syshandler_off
ri_on

fleet! = 4
repeat

  speed! = 0
  autopilot! = 1
  aircraft_mode! = AIRCRAFT_MODE_REFUEL!
  textat 14, 12, " refueling  " : memset $d9ed, 13, 2
  
  for j! = 0 to 12
    ufo_on![j!] = 0
    ufo_hit![j!] = 0
  next j!
  
  rem TEST UFOS
  ufo_on![2] = 1 : ufo_path![2] = 0
  ufo_on![3] = 1 : ufo_path![3] = 0
  ufo_on![4] = 1 : ufo_path![4] = 0

  main_loop:

    ;rtextat 2, 0, aircraft_xpos
    ''wait_loop:
      watch RASTER_POS, 248
      ''if peek!($d011) & %10000000 = %10000000 then goto wait_loop
    
    poke 53280, 2
    
    call query_joystick
    call update_sprites
    
    microspeed! = rshift!(speed!, 4)

    rem --
    rem -- scroll the stage to left or right
    rem --
    
    if dir! = 0 then
      scroll! = scroll! + microspeed!
      aircraft_xpos = aircraft_xpos - microspeed!
      if aircraft_xpos < 0 then aircraft_xpos = aircraft_xpos + 5120
      if scroll! > 7 then
        scroll! = scroll! & %00000111
        call shift_right
      else
        call update_radar
        call poll_collisions
        call move_ufos
      endif
    else
      scroll! = scroll! - microspeed!
      aircraft_xpos = aircraft_xpos + microspeed!
      if aircraft_xpos > 5119 then aircraft_xpos = aircraft_xpos - 5120
      if scroll! > 249 then
        scroll! = scroll! & %00000111
        call shift_left
      else
        call update_radar
        call poll_collisions
        call move_ufos
      endif
    endif
    
    
    dec frame_count!
    call actions
    
    
    poke 53280, 0
    goto main_loop
  
until fleet! = 0
  
  
asm "
  ECHO *
"
  
rem -- graphics data
origin $1ffe

rem -- chars ($2000-2800)
incbin "resources/charset.64c"

rem -- sprites ($2800-$3c7a)
incbin "resources/sprites.bin"

rem -- map ($4000-)
origin $4000
incbin "resources/graphics.bin"

origin $5440
incbin "resources/Black_Hawk5400_cut_headless.sid"

instructions:
  memset 1024, 40, 32
  memcpy @instructions1!, 1064, 920
  memset 1984, 40, 32
  
  gosub wait_key
    
  memcpy @instructions2!, 1064, 920  

  gosub wait_key
  return
  
  wait_key:
    if inkey!() = 0 then goto wait_key
    return
  
data instructions1![] = ~
  32, 23,  5, 12,  3, 15, 13,  5, 32, 20, 15, 32,  6, 12, 25,  9, 14,  7, 32, 19,  1, 21,  3,  5, 18, 19, 33, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32, 61, 61, 61, 61, 61, 61, 61, 61, 61, 61, 61, 61, 61, 61, 61, 61, 61, 61, 61, 61, 61, 61, 61, 61, 61, 61, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32,  9, 14, 32, 20,  8,  9, 19, 32,  7,  1, 13,  5, 32, 25, 15, 21, 39, 12, 12, 32,  3, 15, 14, 20, 18, 15, 12, 32,  1, 32,  6,  9,  7,  8, 20,  5, 18, 32, 32, ~
  32,  1,  9, 18,  3, 18,  1,  6, 20, 32, 20,  8,  1, 20, 39, 19, 32, 13,  9, 19, 19,  9, 15, 14, 32,  9, 19, 32, 20, 15, 32, 19,  1, 22,  5, 32, 32, 32, 32, 32, ~
  32, 20,  8,  5, 32,  3,  9, 20, 25, 32,  6, 18, 15, 13, 32,  1, 14, 32,  1,  9, 12,  5, 14, 32,  9, 14, 22,  1, 19,  9, 15, 14, 46, 32, 20,  8,  5, 32, 32, 32, ~
  32,  7, 15,  1, 12, 32,  9, 19, 32, 19,  9, 13, 16, 12,  5, 58, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32, 32, 32, 32, 32, 32, 16, 18,  5, 22,  5, 14, 20, 32,  1, 14, 25, 32,  1, 12,  9,  5, 14, 32,  1,  9, 18,  3, 18,  1,  6, 20, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,  6, 18, 15, 13, 32, 12,  1, 14,  4,  9, 14,  7, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32,  9, 14, 19, 20, 18, 21,  3, 20,  9, 15, 14, 19, 58, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32, 21, 19,  5, 32, 10, 15, 25, 19, 20,  9,  3, 11, 32,  9, 14, 32, 16, 15, 18, 20, 32, 49, 46, 32, 16, 21, 12, 12, 32, 21, 16, 32, 20, 15, 32, 32, 32, 32, 32, ~
  32, 12,  9,  6, 20, 44, 32, 16, 21, 12, 12, 32,  4, 15, 23, 14, 32, 20, 15, 32,  4,  5, 19,  3,  5, 14,  4, 44, 32, 16, 21, 12, 12, 32, 12,  5,  6, 20, 32, 32, ~
  32, 15, 18, 32, 18,  9,  7,  8, 20, 32, 20, 15, 32,  9, 14,  3, 18,  5,  1, 19,  5, 32, 15, 18, 32,  4,  5,  3, 18,  5,  1, 19,  5, 32, 19, 16,  5,  5,  4, 32, ~
  32, 15, 18, 32, 13,  1, 11,  5, 32,  1, 32, 21, 45, 20, 21, 18, 14, 46, 32, 16, 18,  5, 19, 19, 32,  6,  9, 18,  5, 32, 20, 15, 32, 12,  1, 21, 14,  3,  8, 32, ~
  32, 16, 18, 15, 10,  5,  3, 20,  9, 12,  5, 46, 32,  9,  6, 32, 20,  8,  5, 32,  1,  9, 18,  3, 18,  1,  6, 20, 32,  3, 15, 12, 12,  9,  4,  5, 19, 32, 32, 32, ~
  32, 23,  9, 20,  8, 32,  1, 12,  9,  5, 14, 32,  1,  9, 18,  3, 18,  1,  6, 20, 32, 15, 18, 32, 16, 18, 15, 10,  5,  3, 20,  9, 12,  5, 44, 32, 25, 15, 21, 32, ~
  32, 12, 15, 19,  5, 32, 15, 14,  5, 32, 12,  9,  6,  5, 46, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 16, 18,  5, 19, 19, 32,  1, 32, 11,  5, 25, 32, 20, 15, 32,  3, 15, 14, 20,  9, 14, 21,  5, 32, 62, 32
  
data instructions2![] = ~
  32, 20,  1, 11,  9, 14,  7, 32, 15,  6,  6, 32,  1, 14,  4, 32, 12,  1, 14,  4,  9, 14,  7, 58, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32, 25, 15, 21, 32,  8,  1, 22,  5, 32, 20, 15, 32, 18,  5, 20, 21, 18, 14, 32, 20, 15, 32, 20,  8,  5, 32,  3,  1, 18, 18,  9,  5, 18, 32, 23,  8,  5, 14, 32, ~
  32, 20,  8,  5, 32,  1,  9, 18,  3, 18,  1,  6, 20, 32,  9, 19, 32, 12, 15, 23, 32, 15, 14, 32,  6, 21,  5, 12, 46, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32, 20,  8,  5, 32,  1, 21, 20, 15, 16,  9, 12, 15, 20, 32, 23,  9, 12, 12, 32,  4, 15, 32, 20,  8,  5, 32, 20,  1, 11,  5, 32, 15,  6,  6, 32,  1, 14,  4, 32, ~
  32, 12,  1, 14,  4,  9, 14,  7, 32, 16, 18, 15,  3,  5,  4, 21, 18,  5, 19, 46, 32,  1, 16, 16, 18, 15,  1,  3,  8, 32, 20,  8,  5, 32,  1,  9, 18, 45, 32, 32, ~
  32,  3, 18,  1,  6, 20, 32,  3,  1, 18, 18,  9,  5, 18, 32, 23,  9, 20,  8, 32, 12, 15, 23, 32, 19, 16,  5,  5,  4, 32,  1, 14,  4, 32, 15, 14, 32, 32, 32, 32, ~
  32, 12, 15, 23, 32,  1, 12, 20,  9, 20, 21,  4,  5, 32, 20, 15, 32,  9, 14,  9, 20,  9,  1, 20,  5, 32, 12,  1, 14,  4,  9, 14,  7, 46, 32, 32, 32, 32, 32, 32, ~
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32,  3, 18,  5,  4,  9, 20, 19, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32, 61, 61, 61, 61, 61, 61, 61, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32,  3, 15,  4,  5, 32, 38, 32, 19,  6, 24, 32, 32, 32,  3, 19,  1,  2,  1, 32,  6,  5, 11,  5, 20,  5, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32,  7, 18,  1, 16,  8,  9,  3, 19, 32, 32, 32, 32, 32,  4,  1, 14,  9,  5, 12, 32,  6,  5, 11,  5, 20,  5, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32, 13, 21, 19,  9,  3, 32, 32, 32, 32, 32, 32, 32, 32, 39, 18,  9,  4,  5, 32, 15,  6, 32, 20,  8,  5, 32, 22,  1, 12, 11, 25, 18,  5, 19, 39, 32, 32, 32, 32, ~
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,  2, 25, 32, 18, 46, 32, 23,  1,  7, 14,  5, 18, 44, 32,  1,  4, 15, 16, 20,  5,  4, 32, 32, 32, 32, 32, ~
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 20, 15, 32, 19,  9,  4, 32,  2, 25, 32,  3, 18,  5,  1, 20,  9, 22,  5, 32, 19, 16,  1, 18, 11, 19, 32, ~
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32, 20,  8,  9, 19, 32,  7,  1, 13,  5, 32, 23,  1, 19, 32, 23, 18,  9, 20, 20,  5, 14, 32,  9, 14, 32, 24,  3, 61,  2,  1, 19,  9,  3, 46, 32, 32, 32, 32, 32, ~
  32, 22,  9, 19,  9, 20, 32,  8, 20, 20, 16, 19, 58, 47, 47, 24,  3, 45,  2,  1, 19,  9,  3, 46, 14,  5, 20, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, ~
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 16, 18,  5, 19, 19, 32,  1, 32, 11,  5, 25, 32, 20, 15, 32,  2,  5,  7,  9, 14, 32, 62, 32

